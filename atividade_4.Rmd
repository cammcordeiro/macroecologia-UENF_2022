---
pagetitle: Atividade 4
output:
  html_document:
    pandoc_args: [
      "--number-offset=4"]
    toc: yes
    toc_float: true
    number_sections: true
    code_folding: "show"
---

<style>
body {
text-align: justify}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

# Atividade 4 {.unnumbered}

<br></br>

## Dados de peixes recifais
Para a atividade 4, partiremos dos primeiros passos da atividade 1, mas com algumas modificações na escala do mapa (global desta vez). Para tal, bastar realizar estes primeiros passos rodando este `chunck` de código abaixo. 

```{r}

library(letsR)
library(tidyverse)

# Importanto o shapefile
borb <- rgdal::readOGR(dsn = "data/Chaetodontidae_NewWorld.shp")

# Criando raster
borb_maps <- lets.presab(borb, resol = 3, 
                         cover = 0.01,
                         remove.cells = FALSE)

# Criando matrix de presença e ausência
borb_pa <- borb_maps$Presence_and_Absence_Matrix

```

<br></br>

## Riqueza de espécies na América
A manipulação e tratamento de dados espaciais tipo .shp exigem um profundo conhecimento sobre os dados e a forma como eles são armazenados. Se quiserem saber mais sobre como utilizar o R para tratar este tipo de dados, recorram a livros como Applied spatial data analysis with R (Bivand et al. 2013) ou An introduction to R for spatial analysis and mapping (Brunsdown & Comber 2015). Felizmente, existe um pacote chamado letsR (Vilela & Villalobos 2015) que possui uma grande variedade de ferramentas úteis para macroecólogos. Nós já instalamos e carregamos este pacote no início da aula e podemos utilizar suas funções para fazer mais alguns mapas.
Vamos utilizar a função lets.presab para criar um raster (i.e., arquivo tipo imagem que armazena informações em cada um de seus pixels; digite ‘arquivo raster’ no Google para mais detalhes) sumarizando a riqueza de espécie de peixes borboletas na América do Sul. Neste caso, a resolução do nosso arquivo de raster será de 3x3 graus (i.e., cada pixel ou célula tem tamanho 3 por 3 graus); mude a resol para valores 4 ou 5 e você verá a diferença na figura final. Já o argumento cover garante que somente pixels que tenham mais de 1% de sua área sobre do continente sejam mantidos (mude estes valores e veja a
diferença no mapa resultante). Como nosso objetivo é um mapa da América, as coordenadas limites foram definidas para realizar o exercício somente ao longo da extensão desejada (argumentos xmn, xmx, ymn e ymx da função `lets.presab`).

<br></br>


## Padrões geográficos de diversidade filogenética
Para entendermos melhor como podemos utilizar diferentes informações em larga escala, vamos proceder com um exercício sobre diversidade filogenética. Muito da macroecologia tem sido feito no sentido de incorporar informações filogenéticas às análises espaciais/geográficas. Desta forma, os padrões que analisamos em larga escala contém informações não somente da distribuição dos organismos mas também da evolução/história evolutiva das linhagens (vide o nome desta disciplina). Eu não entrarei em detalhes
sobre a teoria por trás destes tipos de métricas, mas para maiores informações vejam papers recentes na area (e.g., Ives & Helmus 2010, Mouquet et al. 2012, Miller et al. 2016 Tucker et al. 2016).

### Base de dados filogenéticos
Para iniciar, nós precisamos encontrar uma filogenia do grupo com o qual nós estamos trabalhando. Para aves, mamíferos, possivelmente répteis e alguns anfíbios este tipo de informação pode ser encontrada em algum trabalho já publicado.

Como estamos tratando de peixes, boa parte das espécies já está descrita e a filogenia da maior parte delas também encontra-se disponível. Esta filogenia usada aqui foi encontrada a partir de uma publicacao recente (ver Leprieur et al. 2015).
Primeiro tenham certeza de que os arquivos estão na pasta onde vocês estão rodando este script e que vocês conseguem acessá-los a partir do R. Depois, é so carregar a árvore filogenética e proseguir com algumas manipulações simples para visualizá-la. No meio do código abaixo, nós precisaremos criar um outro nome para as espécies de peixes para que tanto o shape borb_maps quanto o objeto filo contenham exatamente o mesmo nome. Se houver pequenas diferenças (e.g., *“Tachyglossus aculeatus”* em vez de *“Tachyglossus_aculeatus”*) as funções vão travar e você não conseguirá computar os índices e fazer os procedimentos.

```{r}
# Caso não tenha install.packages('ape')

# lendo arvore filogenetica
library(ape)

```


```{r}
filo <- read.tree("data/newChaetNode.txt")
filo
```


```{r}
plot.phylo(filo, type = "fan", edge.color = "gray", cex = 0.1)
```


```{r}

# algumas informacoes uteis is.rooted(filo)
# is.ultrametric(filo) filo$tip.label

# mudando nome de mami de acordo com a filogenia 
# função para mudar nome
muda_nome = function(x) {
unlist(lapply(strsplit(x = as.character(x), " "), function(x) {
paste(x[1], x[2], sep = "_")
}))
}
# mudando nome da matrix local vs espécie
colnames(borb_pa) = muda_nome(colnames(borb_pa))

# especies presentes tanto na filogenia quanto no arquivo
# mami separando somente as especies em ambos os objetos

sp <- intersect(filo$tip.label, colnames(borb_pa))

# excluindo as especies do mapa para reter somente as
# especies presentes na filogenia
borb <- borb[borb$binomialMod %in% sp, ]
dim(borb)
```


```{r}
# excluindo as especies da matrix para reter somente as
# especies presentes na filogenia
borb_pa <- borb_pa[, colnames(borb_pa) %in% sp]
dim(borb_pa)

rm(sp)

```

<br></br>

### Carregando e limpando a árvores filogenética
Outro ponto importante é retirar da filogenia todas as espécies que não serão utilizadas. Isto facilitará o cálculo e manterá somente as espécies presentes em **mat**.

```{r}

# Caso não tenha install.packages('picante')

library(picante)

```

```{r}
# deixar na filo as sp da matrix
filo_gamb <- prune.sample(samp = borb_pa, phylo = filo)
plot.phylo(filo_gamb, type = "fan", edge.color = "gray", cex = 0.5)
```


### Calculando as métricas filogenéticas
Existem diversas métricas filogenéticas que trazem informacoes distintas sobre a comunidade. A mais comum e mais antiga é Diversidade Filogenética, que nada mais é do que a soma dos ramos da àrvore filogenética correspondentes às especies presentes na comunidade.

```{r}

# Faith's Phylogenetic diversity
PD <- pd(samp = borb_pa, tree = filo_gamb, include.root = T)

```

Uma outra informaçao complementar é fornecida pela distancia média dos ramos filogenéticos correspondentes às especies presentes em uma assémbleia. Esse indice da uma ideia do quao filogeneticamente próximas são as especies presentes em uma comunidade. Se os valores sao pequenos, mais relacionadas filogeneticamente são as espécies; se mais distantes, mais diferentes elas sao em termos de história evolutiva. Vamos calculareste novo indice e juntá-lo àqueles anteriormente calculados.

```{r}
# more indices: Mean pairwise distance separating taxa in a
# community
phydist <- cophenetic(filo_gamb) #distancia fologenetica entre especies
mpd.result <- mpd(borb_pa, phydist)
rm(phydist)
```

```{r}
PD <- data.frame(PD, mpd.result)
PD[is.na(PD)] <- 0

head(PD[order(PD$SR, decreasing = T), ], 10)
```

```{r}
# relação entre todos os índices calculados
plot(PD)
```

### Plotando os índices no mapa
Agora que ja temos uma planilha contendo cada um destes indices, nos podemos utilizar o mapa de riqueza para mapear os indices no espaço.

```{r}
# criar uma cópia para evitar perder informações
borb2 <- borb_maps
```

```{r}
# matriz, raster e variaveis calculadas estao na mesma ordem
all.equal(rowSums(borb_pa), values(borb2$Richness_Raster))

```

```{r}
all.equal(rowSums(borb_pa), PD$SR)
```

```{r}
plot(borb2, main = "Riqueza de especies")
```

```{r}
# basta mudar os valores do raster original pela metrica
# desejada PDiv

raster::values(borb2$Richness_Raster) <- PD$PD

plot(borb2, main = "Diversidade filogenetica")
```

```{r}
# MPDist
values(borb2$Richness_Raster) <- PD$mpd.result
plot(borb2, main = "Mean Pairwise Distance")
```

Que padrões vocês enxergam? Eles são os mesmos entre os indices? Quais são os mecanismos que explicam estes padrões?
<br></br>


## Exercício de métricas funcionais
<br></br>

### Dados

Para este exercício vamos utilizar duas planilhas que estão disponíveis no drive da disciplina. O primeiro deles é uma lista de ocorrência de espécies de peixes-borboleta (`chaet_dist.csv`), e o segundo é uma lista de atributos de peixes recifais (`trait.txt`).
```{r}
trait <- read.table("data/trait.txt", header=T)
occur <- read.csv("data/chaet_dist.csv", sep=";")
```


<br></br>

### Organizando os dados

O passo inicial é selecionar apenas os atributos das espécies que estão presentes na lista de ocorrência, pois a lista de atributos engloba muitas outras espécies.Em seguida, vamos checar as tabelas para garantir que ambas tenham os nomes de espécies exatamente iguais.

```{r}

# subset apenas com os dados de Chaetodontidae
chaet_trait <- droplevels(subset(trait, Family == "Chaetodontidae")) 

# eliminando os dados NA
chaet_trait <- na.omit(chaet_trait) 
```
<br></br>


Tudo estando correto, podemos fazer uma compatibilização das espécies presentes com os atributos para termos estar informações na mesma planilha.

```{r}

# subset apenas com os dados de Chaetodontidae
chaet_trait <- droplevels(subset(trait, Family == "Chaetodontidae")) 

# eliminando os dados NA
chaet_trait <- na.omit(chaet_trait) 

# selecionando as ocorrências das spp em cada uma das quatro bacias oceânicas
chaet_trait$Atl <- occur$Atlantic[match(chaet_trait$Genus_and_species, occur$Genus_and_species)] 
chaet_trait$Ind <- occur$Indian[match(chaet_trait$Genus_and_species, occur$Genus_and_species)]
chaet_trait$TEP <- occur$TEP[match(chaet_trait$Genus_and_species, occur$Genus_and_species)]
chaet_trait$Pac <- occur$Pacific[match(chaet_trait$Genus_and_species, occur$Genus_and_species)]

```
<br></br>

A partir daqui, podemos utilizar os atributos para calcular as entidades funcionais presentes e as distâncias entre elas, utilizando a distância de Gower.

```{r}

# install.packages("FD")

library(FD)

# cálculo da dissimilaridade de Gower baseado nos atributos das espécies
dist <- gowdis(chaet_trait[,14:19])

#cálculo da análise de componentes principais
pcoa <- cmdscale(dist, k = 4) 

# dataframe juntando todas as informações de atributos, ocorrências e coordenadas na pcoa para todas as espécies
chaet_info <- cbind(pcoa, chaet_trait) 

```
<br></br>

Com a matriz de distâncias pronta, é possível avaliar graficamente o espaço funcional total e a contribuição das assembleias de peixes-borboleta em cada uma das províncias indicadas na planilha de ocorrências (Pac = Pacífico, TEP = Pacífico Tropical Leste, Atlan = Atlântico, Indi = Índico).

```{r}
par(mfrow = c(2,2)) #divide a área de plot em quatro

#plots com:
#[1] espaço funcional global
#[2] o cálculo do número de spp por região
#[3] o polígono convexo para todas as entidades funcionais do mundo
#[4] o polígono convexo apenas para as spp que ocorrem em uma das regiões

plot(pcoa, xlab = "PC1", ylab = "PC2", main = "Atlantic")
legend("topright", legend = sum(chaet_info$Atl), bty = "n")
ordihull(pcoa, groups = chaet_info$Size_class <= 1, draw = "polygon", col = "grey", alpha=50)
ordihull(pcoa, groups= chaet_info$Atl==1, col= "orange", draw="polygon", show.group=TRUE, alpha=50)

plot(pcoa, xlab = "PC1", ylab = "PC2", main = "TEP")
legend("topright", legend = sum(chaet_info$TEP), bty = "n")
ordihull(pcoa, groups = chaet_info$Size_class <= 1, draw = "polygon", col = "grey", alpha=50)
ordihull(pcoa, groups= chaet_info$TEP==1, col= "green", draw="polygon", show.group=TRUE, alpha=50)

plot(pcoa, xlab = "PC1", ylab = "PC2", main = "Indian")
legend("topright", legend = sum(chaet_info$Ind), bty = "n")
ordihull(pcoa, groups = chaet_info$Size_class <= 1, draw = "polygon", col = "grey", alpha=50)
ordihull(pcoa, groups= chaet_info$Ind==1, col= "blue", draw="polygon", show.group=TRUE, alpha=50)

plot(pcoa, xlab = "PC1", ylab = "PC2", main = "Pacific")
legend("topright", legend = sum(chaet_info$Pac), bty = "n")
ordihull(pcoa, groups = chaet_info$Size_class <= 1, draw = "polygon", col = "grey", alpha=50)
ordihull(pcoa, groups= chaet_info$Pac==1, col= "red", draw="polygon", show.group=TRUE, alpha=50)

```
<br></br>


### Métricas funcionais

Utilizando um exemplo do pacote *FD*, vamos dar uma olhada em como podemos extrair métricas funcionais.

Para o cálculo são necessárias duas matrizes:
-   uma com as espécies nas linhas e os atributos nas colunas. Os atributos devem ser numéricos ou fatores.
-   uma com as assembleias ou comunidades ou amostras nas linhas e as espécies nas colunas.
<br></br>

**É muito importante que os nomes das espécies sejam exatamente os mesmos nas duas matrizes. Como os nomes serão colocados como nomes das linhas na primeira matriz, estas não podem estar separadas por espaço ou caracteres especiais (use "_", "." ou "-").**

```{r}
# cálculo dos índices funcionais
 
# [1] traits - spp (linhas) x traits (colunas) - aqui os traits 
# [2] ocorrencia - regiões (linhas) x spp (colunas)

traits <- chaet_info[,18:23]
rownames(traits) <- chaet_info$Genus_and_species
traits$Diet_2012 <- as.factor(traits$Diet_2012) # transformar caracteres em fatores
traits$Home_range <- as.factor(traits$Home_range)
traits$Diet_2012 <- as.factor(traits$Diet_2012)
traits$Activity <- as.factor(traits$Activity)
traits$Schooling <- as.factor(traits$Schooling)
traits$Level <- as.factor(traits$Level)

ocorrencias <- chaet_info[,24:27]
rownames(ocorrencias) <- chaet_info$Genus_and_species
```
<br></br>


Em seguida, podemos aplicar a função `dbFD` para calcular os índices funcionais padrão fornecidos pela função.
```{r}
indices <- dbFD(traits, t(ocorrencias))
indices
```

O arquivo de saída da função também é no formato de lista, para acessá-lo, basta utilizar o símbolo de `$` entre o nome do arquivo e a matriz que deverá ser avaliada ou utilizada.

```{r}
indices$FDiv
```
<br></br>


## Referências
-   Ives AR, Helmus MR (2010). Phylogenetic metrics of community similarity. The American
Naturalist, 176, E128–E142.
-   Leprieur F, Colosio S, Descombes P, Parravicini V, Kulbicki M, Cowman PF et al. (2015) Historical and contemporary determinants of global phylogenetic structure in tropical reef fish faunas. Ecography, 39, 825–835.
-   Miller ET, Farine DR, Trisos CH (2016) Phylogenetic community structure metrics and null models: A review with new methods and software. Ecography, 40, 461–477.
- Mouquet N, Devictor V, Meynard CN, Munoz F, Bersier L-F, Chave J et al. (2012) Ecophylogenetics: Advances and perspectives. Biological Reviews, 87, 769–785.
-   Tucker CM, Cadotte MW, Carvalho SB, Davies TJ, Ferrier S, Fritz SA et al. (2016) A guide to phylogenetic metrics for conservation, community ecology and macroecology. Biological Reviews, 92, 698–715.
-   Vilela B, Villalobos F (2015) letsR: A new r package for data handling and analysis in macroecology. Methods in Ecology and Evolution, 6, 1229–1234.